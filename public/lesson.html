<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>Lesson Detail - WeGrow Learning Platform</title>  
  <script src="https://cdn.tailwindcss.com"></script>  
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
  <style>  
    /* Lesson content styling */  
    .lesson-content h1 {  
      font-size: 1.8rem;  
      font-weight: 700;  
      margin-top: 1.5rem;  
      margin-bottom: 1rem;  
    }  
    .lesson-content h2 {  
      font-size: 1.5rem;  
      font-weight: 600;  
      margin-top: 1.25rem;  
      margin-bottom: 0.75rem;  
    }  
    .lesson-content h3 {  
      font-size: 1.25rem;  
      font-weight: 600;  
      margin-top: 1rem;  
      margin-bottom: 0.5rem;  
    }  
    .lesson-content p {  
      margin-bottom: 1rem;  
      line-height: 1.6;  
    }  
    .lesson-content ul, .lesson-content ol {  
      margin-bottom: 1rem;  
      padding-left: 1.5rem;  
    }  
    .lesson-content ul {  
      list-style-type: disc;  
    }  
    .lesson-content ol {  
      list-style-type: decimal;  
    }  
    .lesson-content li {  
      margin-bottom: 0.5rem;  
    }  
    .lesson-content a {  
      color: #3182ce;  
      text-decoration: underline;  
    }  
    .lesson-content blockquote {  
      border-left: 4px solid #e2e8f0;  
      padding-left: 1rem;  
      font-style: italic;  
      margin: 1rem 0;  
    }  
    .lesson-content pre {  
      background-color: #f7fafc;  
      padding: 1rem;  
      border-radius: 0.25rem;  
      overflow-x: auto;  
      margin: 1rem 0;  
    }  
    .lesson-content code {  
      background-color: #f7fafc;  
      padding: 0.2rem 0.4rem;  
      border-radius: 0.25rem;  
      font-family: monospace;  
    }  
    .lesson-content img {  
      max-width: 100%;  
      height: auto;  
      margin: 1rem 0;  
      border-radius: 0.25rem;  
    }  
    .lesson-content table {  
      width: 100%;  
      border-collapse: collapse;  
      margin: 1rem 0;  
    }  
    .lesson-content table th, .lesson-content table td {  
      border: 1px solid #e2e8f0;  
      padding: 0.5rem;  
    }  
    .lesson-content table th {  
      background-color: #f7fafc;  
    }  
  </style>  
</head>  
<body class="bg-gray-50 min-h-screen">  
  <div x-data="lessonDetailApp()" x-init="init()">  
    <!-- Header -->  
    <header class="bg-white shadow">  
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">  
        <div class="flex justify-between items-center">  
          <div>  
            <a :href="`/course/${courseSlug}`" class="text-blue-600 hover:text-blue-800">  
              <i class="fas fa-arrow-left mr-2"></i> Back to Course  
            </a>  
          </div>  
        </div>  
      </div>  
    </header>  

    <!-- Loading state -->  
    <div x-show="!lesson && !error" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">  
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>  
      <p class="mt-2 text-gray-600">Loading lesson content...</p>  
    </div>  

    <!-- Error state -->  
    <div   
      x-show="error"   
      class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center"  
    >  
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">  
        <strong class="font-bold">Error!</strong>  
        <span class="block sm:inline" x-text="error"></span>  
      </div>  
      <div class="mt-4">  
        <a :href="`/course/${courseSlug}`" class="text-blue-600 hover:text-blue-800">  
          Return to Course  
        </a>  
      </div>  
    </div>  

    <!-- Lesson content -->  
    <main   
      x-show="lesson && !error"   
      class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12"  
    >  
      <!-- Course info bar -->  
      <div class="bg-gray-100 rounded-lg p-4 mb-8 flex items-center" x-show="course">  
        <div>  
          <span class="text-gray-600 text-sm">Course:</span>  
          <span class="ml-2 font-medium" x-text="course?.title"></span>  
        </div>  
      </div>  
      
      <!-- Lesson header -->  
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">  
        <h1 class="text-3xl font-bold text-gray-900 mb-4" x-text="lesson.title"></h1>  
        
        <div class="flex flex-wrap items-center text-sm text-gray-600 mb-4">  
          <!-- Optional lesson metadata -->  
          <div class="mr-6 mb-2" x-show="lesson.moduleName">  
            <i class="fas fa-layer-group mr-1"></i>  
            <span x-text="lesson.moduleName"></span>  
          </div>  
          
          <div class="mr-6 mb-2" x-show="lesson.duration">  
            <i class="fas fa-clock mr-1"></i>  
            <span x-text="lesson.duration"></span>  
          </div>  
        </div>  
        
        <p class="text-gray-700" x-text="lesson.description || 'No description available'"></p>  
      </div>  
      
      <!-- Lesson content -->  
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">  
        <div class="lesson-content" x-html="lesson.content"></div>  
      </div>  
      
      <!-- Navigation buttons -->  
      <div class="flex justify-between items-center">  
        <button   
          x-show="prevLessonSlug"   
          @click="navigateToLesson(prevLessonSlug)"  
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded flex items-center"  
        >  
          <i class="fas fa-chevron-left mr-2"></i>  
          Previous Lesson  
        </button>  
        
        <div></div> <!-- Spacer -->  
        
        <button   
          x-show="nextLessonSlug"   
          @click="navigateToLesson(nextLessonSlug)"  
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded flex items-center"  
        >  
          Next Lesson  
          <i class="fas fa-chevron-right ml-2"></i>  
        </button>  
      </div>  
    </main>  
    
    <!-- Footer -->  
    <footer class="bg-white border-t border-gray-200 mt-12">  
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">  
        <p class="text-center text-gray-500 text-sm">  
          &copy; 2025 WeGrow Learning Platform. All rights reserved.  
        </p>  
      </div>  
    </footer>  
  </div>  

  <script>  
    // Alpine.js component for lesson detail page  
    function lessonDetailApp() {  
      return {  
        lesson: null,  
        course: null,  
        error: null,  
        courseSlug: '',  
        lessonSlug: '',  
        lessonIndex: -1,  
        nextLessonSlug: null,  
        prevLessonSlug: null,  
        allLessons: [],  
        
        init() {  
          // Extract course and lesson slugs from URL  
          const pathSegments = window.location.pathname.split('/');  
          const courseIndex = pathSegments.indexOf('course');  
          
          if (courseIndex !== -1 && pathSegments.length > courseIndex + 3) {  
            this.courseSlug = pathSegments[courseIndex + 1];  
            this.lessonSlug = pathSegments[courseIndex + 3];  
          }  
          
          if (!this.courseSlug || !this.lessonSlug) {  
            this.error = 'Invalid URL format';  
            return;  
          }  
          
          // Try to load from localStorage first (faster user experience)  
          this.loadFromLocalStorage();  
          
          // Then fetch from API for fresh data  
          this.fetchLessonData();  
        },  
        
        loadFromLocalStorage() {  
          try {  
            // Get current lesson and course from localStorage (set by course detail page)  
            const lessonStr = localStorage.getItem('currentLesson');  
            const courseStr = localStorage.getItem('currentCourse');  
            
            if (lessonStr) {  
              this.lesson = JSON.parse(lessonStr);  
            }  
            
            if (courseStr) {  
              this.course = JSON.parse(courseStr);  
              
              // Extract all lessons from course for navigation  
              this.extractLessonsFromCourse();  
            }  
          } catch (err) {  
            console.error('Error loading from localStorage:', err);  
          }  
        },  
        
        async fetchLessonData() {  
          try {  
            // Fetch lesson data from API  
            const response = await fetch(`/.netlify/functions/lesson-detail?courseSlug=${this.courseSlug}&lessonSlug=${this.lessonSlug}`);  
            
            if (!response.ok) {  
              throw new Error(`Failed to fetch lesson. Status: ${response.status}`);  
            }  
            
            const data = await response.json();  
            
            if (data.error) {  
              throw new Error(data.error);  
            }  
            
            // Update with fresh data  
            if (data.lesson) {  
              this.lesson = data.lesson;  
              document.title = `${this.lesson.title} - WeGrow Learning Platform`;  
            }  
            
            if (data.course) {  
              this.course = data.course;  
              
              // Extract all lessons for navigation  
              this.extractLessonsFromCourse();  
            }  
            
          } catch (err) {  
            console.error('Error fetching lesson:', err);  
            this.error = err.message || 'Failed to load lesson';  
          }  
        },  
        
        extractLessonsFromCourse() {  
          if (!this.course) return;  
          
          // Check different possible locations for lessons  
          if (this.course.lessons && Array.isArray(this.course.lessons)) {  
            this.allLessons = this.course.lessons;  
          } else if (this.course.sections && Array.isArray(this.course.sections)) {  
            this.allLessons = this.course.sections;  
          } else if (this.course.modules && Array.isArray(this.course.modules)) {  
            // If modules contain lessons, flatten them  
            this.allLessons = [];  
            this.course.modules.forEach(module => {  
              if (module.lessons && Array.isArray(module.lessons)) {  
                const moduleLessons = module.lessons.map(lesson => ({  
                  ...lesson,  
                  moduleName: module.name || module.title  
                }));  
                this.allLessons.push(...moduleLessons);  
              }  
            });  
          }  
          
          // Find current lesson index  
          this.lessonIndex = this.allLessons.findIndex(l =>   
            (l.slug && l.slug === this.lessonSlug) ||   
            (l._id && l._id.toString() === this.lessonSlug)  
          );  
          
          // Set up next/previous navigation  
          if (this.lessonIndex > 0) {  
            const prevLesson = this.allLessons[this.lessonIndex - 1];  
            this.prevLessonSlug = prevLesson.slug || prevLesson._id;  
          } else {  
            this.prevLessonSlug = null;  
          }  
          
          if (this.lessonIndex < this.allLessons.length - 1) {  
            const nextLesson = this.allLessons[this.lessonIndex + 1];  
            this.nextLessonSlug = nextLesson.slug || nextLesson._id;  
          } else {  
            this.nextLessonSlug = null;  
          }  
        },  
        
        navigateToLesson(lessonSlug) {  
          if (!lessonSlug) return;  
          
          // Find the lesson in our array  
          const targetLesson = this.allLessons.find(l =>   
            (l.slug && l.slug === lessonSlug) ||   
            (l._id && l._id.toString() === lessonSlug)  
          );  
          
          if (targetLesson) {  
            // Update localStorage  
            localStorage.setItem('currentLesson', JSON.stringify(targetLesson));  
            
            // Navigate to the lesson page  
            window.location.href = `/course/${this.courseSlug}/lesson/${lessonSlug}`;  
          }  
        }  
      };  
    }  
  </script>  
</body>  
</html>  